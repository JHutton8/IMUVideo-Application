// AHRS.js - Madgwick & Mahony sensor fusion algorithms
// Minimal implementation for 9-DOF IMU orientation tracking
!function(){"use strict";function t(t,i,s,h,e,n,a,r,o,u){var c=this.sampleInterval/1e3,f=this.beta,l=this.q0,d=this.q1,m=this.q2,p=this.q3,g=l*l+d*d+m*m+p*p,q=2*l,x=2*d,v=2*m,y=2*p,b=q*l,w=q*d,M=q*m,A=x*d,I=x*m,k=v*m,F=q*p,P=x*p,S=v*p,j=e*e+n*n+a*a,z=Math.sqrt(j);if(0!==j){e/=z,n/=z,a/=z;var C=2*(d*a-p*n)-e,D=2*(p*m-l*a)-n,E=2*(l*n-d*m)-a,G=2*f*(C*(-.5*q*d+.5*x*l+.5*v*p-.5*y*m)+D*(-.5*q*m-.5*x*p+.5*v*l+.5*y*d)+E*(-.5*q*p+.5*x*m-.5*v*d+.5*y*l)),H=2*f*(C*(.5*q*l-.5*x*d-.5*v*m+.5*y*p)+D*(.5*q*p+.5*x*m-.5*v*d-.5*y*l)+E*(-.5*q*m+.5*x*p+.5*v*l-.5*y*d)),J=2*f*(C*(.5*q*m+.5*x*p+.5*v*l-.5*y*d)+D*(-.5*q*l+.5*x*d-.5*v*m-.5*y*p)+E*(.5*q*p-.5*x*m+.5*v*d+.5*y*l)),K=2*f*(C*(-.5*q*p+.5*x*m+.5*v*d+.5*y*l)+D*(.5*q*m-.5*x*p+.5*v*l+.5*y*d)+E*(.5*q*l+.5*x*d+.5*v*m-.5*y*p));if(r*r+o*o+u*u>0){var L=Math.sqrt(r*r+o*o+u*u);r/=L,o/=L,u/=L;var N=2*(m*u-p*o)-r,O=2*(p*d-l*u)-o,Q=2*(l*o-d*m)-u,R=f*(N*(-.5*q*d+.5*x*l+.5*v*p-.5*y*m)+O*(-.5*q*m-.5*x*p+.5*v*l+.5*y*d)+Q*(-.5*q*p+.5*x*m-.5*v*d+.5*y*l)),T=f*(N*(.5*q*l-.5*x*d-.5*v*m+.5*y*p)+O*(.5*q*p+.5*x*m-.5*v*d-.5*y*l)+Q*(-.5*q*m+.5*x*p+.5*v*l-.5*y*d)),U=f*(N*(.5*q*m+.5*x*p+.5*v*l-.5*y*d)+O*(-.5*q*l+.5*x*d-.5*v*m-.5*y*p)+Q*(.5*q*p-.5*x*m+.5*v*d+.5*y*l)),V=f*(N*(-.5*q*p+.5*x*m+.5*v*d+.5*y*l)+O*(.5*q*m-.5*x*p+.5*v*l+.5*y*d)+Q*(.5*q*l+.5*x*d+.5*v*m-.5*y*p));G+=R,H+=T,J+=U,K+=V}i-=G,s-=H,h-=J}var W=.5*(-d*i-m*s-p*h),X=.5*(l*i+m*h-p*s),Y=.5*(l*s-d*h+p*i),Z=.5*(l*h+d*s-m*i);l+=W*c,d+=X*c,m+=Y*c,p+=Z*c;var $=Math.sqrt(l*l+d*d+m*m+p*p);this.q0=l/$,this.q1=d/$,this.q2=m/$,this.q3=p/$}function i(t){this.sampleInterval=t&&t.sampleInterval?t.sampleInterval:20,this.beta=t&&t.beta?t.beta:.1,this.q0=1,this.q1=0,this.q2=0,this.q3=0}i.prototype={constructor:i,update:t,getQuaternion:function(){return[this.q0,this.q1,this.q2,this.q3]},toEuler:function(){var t=this.q0,i=this.q1,s=this.q2,h=this.q3,e=2*(t*i+s*h),n=1-2*(i*i+s*s),a=Math.atan2(e,n),r=2*(t*s-h*i),o=Math.abs(r)>=1?Math.sign(r)*Math.PI/2:Math.asin(r),u=2*(t*h+i*s),c=1-2*(s*s+h*h);return[a,o,Math.atan2(u,c)]}};var s=i;function h(t,i,s,h,e,n,a,r,o,u){var c=this.sampleInterval/1e3,f=this.twoKp,l=this.twoKi,d=this.q0,m=this.q1,p=this.q2,g=this.q3,q=this.integralFBx,x=this.integralFBy,v=this.integralFBz,y=2*d,b=2*m,w=2*p,M=2*g,A=y*d,I=y*m,k=y*p,F=b*m,P=b*p,S=w*p,j=y*g,z=b*g,C=w*g,D=d,E=m,G=p,H=g;if(e*e+n*n+a*a>0){var J=1/Math.sqrt(e*e+n*n+a*a);e*=J,n*=J,a*=J;var K=2*(m*a-g*n)-e,L=2*(g*p-d*a)-n,N=2*(d*n-m*p)-a,O=f*(K*(-.5*y*m+.5*b*d+.5*w*g-.5*M*p)+L*(-.5*y*p-.5*b*g+.5*w*d+.5*M*m)+N*(-.5*y*g+.5*b*p-.5*w*m+.5*M*d)),Q=f*(K*(.5*y*d-.5*b*m-.5*w*p+.5*M*g)+L*(.5*y*g+.5*b*p-.5*w*m-.5*M*d)+N*(-.5*y*p+.5*b*g+.5*w*d-.5*M*m)),R=f*(K*(.5*y*p+.5*b*g+.5*w*d-.5*M*m)+L*(-.5*y*d+.5*b*m-.5*w*p-.5*M*g)+N*(.5*y*g-.5*b*p+.5*w*m+.5*M*d)),T=f*(K*(-.5*y*g+.5*b*p+.5*w*m+.5*M*d)+L*(.5*y*p-.5*b*g+.5*w*d+.5*M*m)+N*(.5*y*d+.5*b*m+.5*w*p-.5*M*g));if(r*r+o*o+u*u>0){var U=1/Math.sqrt(r*r+o*o+u*u);r*=U,o*=U,u*=U;var V=2*(p*u-g*o)-r,W=2*(g*m-d*u)-o,X=2*(d*o-m*p)-u,Y=f*(V*(-.5*y*m+.5*b*d+.5*w*g-.5*M*p)+W*(-.5*y*p-.5*b*g+.5*w*d+.5*M*m)+X*(-.5*y*g+.5*b*p-.5*w*m+.5*M*d)),Z=f*(V*(.5*y*d-.5*b*m-.5*w*p+.5*M*g)+W*(.5*y*g+.5*b*p-.5*w*m-.5*M*d)+X*(-.5*y*p+.5*b*g+.5*w*d-.5*M*m)),$=f*(V*(.5*y*p+.5*b*g+.5*w*d-.5*M*m)+W*(-.5*y*d+.5*b*m-.5*w*p-.5*M*g)+X*(.5*y*g-.5*b*p+.5*w*m+.5*M*d)),tt=f*(V*(-.5*y*g+.5*b*p+.5*w*m+.5*M*d)+W*(.5*y*p-.5*b*g+.5*w*d+.5*M*m)+X*(.5*y*d+.5*b*m+.5*w*p-.5*M*g));O+=Y,Q+=Z,R+=$,T+=tt}q+=O*c,x+=Q*c,v+=R*c,i+=l*q,s+=l*x,h+=l*v}var it=.5*(-E*i-G*s-H*h),st=.5*(D*i+G*h-H*s),ht=.5*(D*s-E*h+H*i),et=.5*(D*h+E*s-G*i);d+=it*c,m+=st*c,p+=ht*c,g+=et*c;var nt=1/Math.sqrt(d*d+m*m+p*p+g*g);this.q0=d*nt,this.q1=m*nt,this.q2=p*nt,this.q3=g*nt,this.integralFBx=q,this.integralFBy=x,this.integralFBz=v}function e(t){this.sampleInterval=t&&t.sampleInterval?t.sampleInterval:20,this.twoKp=t&&t.twoKp?t.twoKp:2,this.twoKi=t&&t.twoKi?t.twoKi:0,this.q0=1,this.q1=0,this.q2=0,this.q3=0,this.integralFBx=0,this.integralFBy=0,this.integralFBz=0}e.prototype={constructor:e,update:h,getQuaternion:function(){return[this.q0,this.q1,this.q2,this.q3]},toEuler:function(){var t=this.q0,i=this.q1,s=this.q2,h=this.q3,e=2*(t*i+s*h),n=1-2*(i*i+s*s),a=Math.atan2(e,n),r=2*(t*s-h*i),o=Math.abs(r)>=1?Math.sign(r)*Math.PI/2:Math.asin(r),u=2*(t*h+i*s),c=1-2*(s*s+h*h);return[a,o,Math.atan2(u,c)]}};var n=e;"undefined"!=typeof module&&module.exports?(module.exports.Madgwick=s,module.exports.Mahony=n):"undefined"!=typeof window&&(window.Madgwick=s,window.Mahony=n)}();
